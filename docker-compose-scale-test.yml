# Horizontal Scaling Test Environment
# - Nginx load balancer
# - 2 API containers (no cron)
# - 1 Cron container (no API exposure)
# - 1 MySQL database
# - Test Dashboard

services:
  # ===========================================
  # Load Balancer
  # ===========================================
  nginx:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    container_name: ${SCALE_NGINX_CONTAINER:-tecnofit-nginx}-test
    ports:
      - "${NGINX_PORT:-9501}:80"
    depends_on:
      hyperf-api-1:
        condition: service_healthy
      hyperf-api-2:
        condition: service_healthy
    networks:
      - tecnofit-scale-test-network
    restart: unless-stopped

  # ===========================================
  # API Container 1
  # ===========================================
  hyperf-api-1:
    build:
      context: .
      dockerfile: ./docker/hyperf/Dockerfile
    container_name: ${SCALE_API1_CONTAINER:-tecnofit-api-1}-test
    working_dir: /data/project
    environment:
      - INSTANCE_ID=api-1
      - CRON_ENABLED=false
      - APP_NAME=${APP_NAME:-TecnoFit}
      - APP_ENV=testing
      - APP_TIMEZONE=${APP_TIMEZONE:-America/Sao_Paulo}
      - SCAN_CACHEABLE=false
      - DB_DRIVER=${DB_DRIVER:-mysql}
      - DB_HOST=${SCALE_TEST_DB_HOST:-mysql-scale-test}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${SCALE_TEST_DB_DATABASE:-hyperf_test}
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAIL_HOST=${MAIL_HOST:-sandbox.smtp.mailtrap.io}
      - MAIL_PORT=${MAIL_PORT:-2525}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@tecnofit.com}
    volumes:
      - ./:/data/project
    depends_on:
      mysql-scale-test:
        condition: service_healthy
    networks:
      - tecnofit-scale-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9501/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ===========================================
  # API Container 2
  # ===========================================
  hyperf-api-2:
    build:
      context: .
      dockerfile: ./docker/hyperf/Dockerfile
    container_name: ${SCALE_API2_CONTAINER:-tecnofit-api-2}-test
    working_dir: /data/project
    environment:
      - INSTANCE_ID=api-2
      - CRON_ENABLED=false
      - APP_NAME=${APP_NAME:-TecnoFit}
      - APP_ENV=testing
      - APP_TIMEZONE=${APP_TIMEZONE:-America/Sao_Paulo}
      - SCAN_CACHEABLE=false
      - DB_DRIVER=${DB_DRIVER:-mysql}
      - DB_HOST=${SCALE_TEST_DB_HOST:-mysql-scale-test}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${SCALE_TEST_DB_DATABASE:-hyperf_test}
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAIL_HOST=${MAIL_HOST:-sandbox.smtp.mailtrap.io}
      - MAIL_PORT=${MAIL_PORT:-2525}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@tecnofit.com}
    volumes:
      - ./:/data/project
    depends_on:
      mysql-scale-test:
        condition: service_healthy
    networks:
      - tecnofit-scale-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9501/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ===========================================
  # Cron Container (Background Jobs Only)
  # ===========================================
  hyperf-cron:
    build:
      context: .
      dockerfile: ./docker/hyperf/Dockerfile
    container_name: ${SCALE_CRON_CONTAINER:-tecnofit-cron}-test
    working_dir: /data/project
    environment:
      - INSTANCE_ID=cron
      - CRON_ENABLED=true
      - APP_NAME=${APP_NAME:-TecnoFit}
      - APP_ENV=testing
      - APP_TIMEZONE=${APP_TIMEZONE:-America/Sao_Paulo}
      - SCAN_CACHEABLE=false
      - DB_DRIVER=${DB_DRIVER:-mysql}
      - DB_HOST=${SCALE_TEST_DB_HOST:-mysql-scale-test}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${SCALE_TEST_DB_DATABASE:-hyperf_test}
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAIL_HOST=${MAIL_HOST:-sandbox.smtp.mailtrap.io}
      - MAIL_PORT=${MAIL_PORT:-2525}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@tecnofit.com}
    volumes:
      - ./:/data/project
    depends_on:
      mysql-scale-test:
        condition: service_healthy
    networks:
      - tecnofit-scale-test-network
    restart: unless-stopped

  # ===========================================
  # Test Dashboard
  # ===========================================
  test-dashboard:
    build:
      context: ./docker/test-dashboard
      dockerfile: Dockerfile
    container_name: ${SCALE_DASHBOARD_CONTAINER:-tecnofit-dashboard}-test
    ports:
      - "${TEST_DASHBOARD_PORT:-3000}:3000"
    environment:
      - API_HOST=nginx
      - API_PORT=80
      - DB_HOST=${SCALE_TEST_DB_HOST:-mysql-scale-test}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${SCALE_TEST_DB_DATABASE:-hyperf_test}
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - AUTO_POPULATE_COUNT=${AUTO_POPULATE_COUNT:-100}
    depends_on:
      mysql-scale-test:
        condition: service_healthy
      nginx:
        condition: service_started
    networks:
      - tecnofit-scale-test-network

  # ===========================================
  # Database
  # ===========================================
  mysql-scale-test:
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    container_name: ${SCALE_MYSQL_CONTAINER:-tecnofit-mysql-scale}-test
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-root}
      - MYSQL_DATABASE=${SCALE_TEST_DB_DATABASE:-hyperf_test}
      - MYSQL_USER=${DB_USERNAME:-hyperf}
      - MYSQL_PASSWORD=${DB_PASSWORD:-hyperf}
      - TZ=${APP_TIMEZONE:-America/Sao_Paulo}
    ports:
      - "${SCALE_TEST_DB_PORT:-3309}:3306"
    volumes:
      - mysql-scale-test-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    networks:
      - tecnofit-scale-test-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u${DB_USERNAME:-hyperf}", "-p${DB_PASSWORD:-hyperf}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ===========================================
  # Mailhog (Email Testing)
  # ===========================================
  mailhog:
    build:
      context: ./docker/mailhog
      dockerfile: Dockerfile
    container_name: ${SCALE_MAILHOG_CONTAINER:-tecnofit-mailhog-scale}-test
    ports:
      - "${SCALE_MAILHOG_SMTP_PORT:-1025}:1025"
      - "${SCALE_MAILHOG_WEB_PORT:-8025}:8025"
    networks:
      - tecnofit-scale-test-network

networks:
  tecnofit-scale-test-network:
    driver: bridge

volumes:
  mysql-scale-test-data:
