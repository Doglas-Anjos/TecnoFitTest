# Horizontal Scaling Proof of Concept
# - Nginx load balancer
# - 2 API containers (no cron)
# - 1 Cron container (no API exposure)
# - 1 MySQL database

services:
  # ===========================================
  # Load Balancer
  # ===========================================
  nginx:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    container_name: ${SCALE_NGINX_CONTAINER:-tecnofit-nginx}
    ports:
      - "${NGINX_PORT:-9501}:80"
    depends_on:
      hyperf-api-1:
        condition: service_healthy
      hyperf-api-2:
        condition: service_healthy
    networks:
      - tecnofit-scale-network
    restart: unless-stopped

  # ===========================================
  # API Container 1
  # ===========================================
  hyperf-api-1:
    build:
      context: .
      dockerfile: ./docker/hyperf/Dockerfile
    container_name: ${SCALE_API1_CONTAINER:-tecnofit-api-1}
    working_dir: /data/project
    environment:
      - INSTANCE_ID=api-1
      - CRON_ENABLED=false
      - APP_NAME=${APP_NAME:-TecnoFit}
      - APP_ENV=${APP_ENV:-dev}
      - APP_TIMEZONE=${APP_TIMEZONE:-America/Sao_Paulo}
      - SCAN_CACHEABLE=${SCAN_CACHEABLE:-false}
      - DB_DRIVER=${DB_DRIVER:-mysql}
      - DB_HOST=${SCALE_DB_HOST:-mysql-scale}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${SCALE_DB_DATABASE:-hyperf}
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAIL_HOST=${MAIL_HOST:-sandbox.smtp.mailtrap.io}
      - MAIL_PORT=${MAIL_PORT:-2525}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@tecnofit.com}
    volumes:
      - ./:/data/project
    depends_on:
      mysql-scale:
        condition: service_healthy
    networks:
      - tecnofit-scale-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9501/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ===========================================
  # API Container 2
  # ===========================================
  hyperf-api-2:
    build:
      context: .
      dockerfile: ./docker/hyperf/Dockerfile
    container_name: ${SCALE_API2_CONTAINER:-tecnofit-api-2}
    working_dir: /data/project
    environment:
      - INSTANCE_ID=api-2
      - CRON_ENABLED=false
      - APP_NAME=${APP_NAME:-TecnoFit}
      - APP_ENV=${APP_ENV:-dev}
      - APP_TIMEZONE=${APP_TIMEZONE:-America/Sao_Paulo}
      - SCAN_CACHEABLE=${SCAN_CACHEABLE:-false}
      - DB_DRIVER=${DB_DRIVER:-mysql}
      - DB_HOST=${SCALE_DB_HOST:-mysql-scale}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${SCALE_DB_DATABASE:-hyperf}
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAIL_HOST=${MAIL_HOST:-sandbox.smtp.mailtrap.io}
      - MAIL_PORT=${MAIL_PORT:-2525}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@tecnofit.com}
    volumes:
      - ./:/data/project
    depends_on:
      mysql-scale:
        condition: service_healthy
    networks:
      - tecnofit-scale-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9501/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ===========================================
  # Cron Container (Background Jobs Only)
  # ===========================================
  hyperf-cron:
    build:
      context: .
      dockerfile: ./docker/hyperf/Dockerfile
    container_name: ${SCALE_CRON_CONTAINER:-tecnofit-cron}
    working_dir: /data/project
    environment:
      - INSTANCE_ID=cron
      - CRON_ENABLED=true
      - APP_NAME=${APP_NAME:-TecnoFit}
      - APP_ENV=${APP_ENV:-dev}
      - APP_TIMEZONE=${APP_TIMEZONE:-America/Sao_Paulo}
      - SCAN_CACHEABLE=${SCAN_CACHEABLE:-false}
      - DB_DRIVER=${DB_DRIVER:-mysql}
      - DB_HOST=${SCALE_DB_HOST:-mysql-scale}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${SCALE_DB_DATABASE:-hyperf}
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAIL_HOST=${MAIL_HOST:-sandbox.smtp.mailtrap.io}
      - MAIL_PORT=${MAIL_PORT:-2525}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@tecnofit.com}
    volumes:
      - ./:/data/project
    depends_on:
      mysql-scale:
        condition: service_healthy
    networks:
      - tecnofit-scale-network
    restart: unless-stopped

  # ===========================================
  # Database
  # ===========================================
  mysql-scale:
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    container_name: ${SCALE_MYSQL_CONTAINER:-tecnofit-mysql-scale}
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-root}
      - MYSQL_DATABASE=${SCALE_DB_DATABASE:-hyperf}
      - MYSQL_USER=${DB_USERNAME:-hyperf}
      - MYSQL_PASSWORD=${DB_PASSWORD:-hyperf}
      - TZ=${APP_TIMEZONE:-America/Sao_Paulo}
    ports:
      - "${SCALE_DB_PORT:-3307}:3306"
    volumes:
      - mysql-scale-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    networks:
      - tecnofit-scale-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u${DB_USERNAME:-hyperf}", "-p${DB_PASSWORD:-hyperf}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

networks:
  tecnofit-scale-network:
    driver: bridge

volumes:
  mysql-scale-data:
