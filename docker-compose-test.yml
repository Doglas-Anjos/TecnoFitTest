# Single Instance Test Environment

services:
  # ===========================================
  # Hyperf API
  # ===========================================
  hyperf-test:
    build:
      context: .
      dockerfile: ./docker/hyperf/Dockerfile
    container_name: ${CONTAINER_HYPERF:-hyperf}-test
    working_dir: /data/project
    volumes:
      - ./:/data/project
    ports:
      - "${HYPERF_TEST_PORT:-9502}:9501"
    environment:
      - INSTANCE_ID=single
      - CRON_ENABLED=true
      - APP_NAME=${APP_NAME:-TecnoFit}
      - APP_ENV=testing
      - APP_TIMEZONE=${APP_TIMEZONE:-America/Sao_Paulo}
      - SCAN_CACHEABLE=false
      - DB_DRIVER=${DB_DRIVER:-mysql}
      - DB_HOST=mysql-test
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-hyperf}_test
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAIL_HOST=${MAIL_HOST:-sandbox.smtp.mailtrap.io}
      - MAIL_PORT=${MAIL_PORT:-2525}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@tecnofit.com}
    depends_on:
      mysql-test:
        condition: service_healthy
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}-test
    privileged: true
    user: root
    stdin_open: true
    tty: true
    command: ["php", "bin/hyperf.php", "start"]

  # ===========================================
  # Test Dashboard
  # ===========================================
  test-dashboard:
    build:
      context: ./docker/test-dashboard
      dockerfile: Dockerfile
    container_name: test-dashboard
    ports:
      - "${TEST_DASHBOARD_PORT:-3000}:3000"
    environment:
      - API_HOST=hyperf-test
      - API_PORT=9501
      - DB_HOST=mysql-test
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-hyperf}_test
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - AUTO_POPULATE_COUNT=${AUTO_POPULATE_COUNT:-100}
    depends_on:
      mysql-test:
        condition: service_healthy
      hyperf-test:
        condition: service_started
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}-test

  # ===========================================
  # Database
  # ===========================================
  mysql-test:
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    container_name: ${CONTAINER_MYSQL:-mysql}-test
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-root}
      - MYSQL_DATABASE=${DB_DATABASE:-hyperf}_test
      - MYSQL_USER=${DB_USERNAME:-hyperf}
      - MYSQL_PASSWORD=${DB_PASSWORD:-hyperf}
      - TZ=${APP_TIMEZONE:-America/Sao_Paulo}
    ports:
      - "${DB_TEST_PORT:-3308}:3306"
    volumes:
      - mysql-test-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}-test
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u${DB_USERNAME:-hyperf}", "-p${DB_PASSWORD:-hyperf}"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5

  # ===========================================
  # Mailhog (Email Testing)
  # ===========================================
  mailhog-test:
    build:
      context: ./docker/mailhog
      dockerfile: Dockerfile
    container_name: ${CONTAINER_MAILHOG:-mailhog}-test
    ports:
      - "${MAIL_TEST_PORT:-1026}:1025"
      - "${MAIL_TEST_WEB_PORT:-8026}:8025"
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}-test

networks:
  tecnofit-network-test:
    name: ${DOCKER_NETWORK:-tecnofit-network}-test
    driver: bridge

volumes:
  mysql-test-data:
    driver: local
