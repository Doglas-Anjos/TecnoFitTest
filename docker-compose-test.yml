services:
  hyperf-test:
    build:
      context: .
      dockerfile: ./docker/hyperf/Dockerfile
    container_name: ${CONTAINER_HYPERF:-hyperf}-test
    volumes:
      - ./:/data/project
    ports:
      - "${HYPERF_TEST_PORT:-9502}:9501"
    working_dir: /data/project
    privileged: true
    user: root
    stdin_open: true
    tty: true
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}-test
    depends_on:
      mysql-test:
        condition: service_healthy
    environment:
      - APP_ENV=testing
      - SCAN_CACHEABLE=false
      - DB_HOST=mysql-test
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-hyperf}_test
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - MAIL_HOST=sandbox.smtp.mailtrap.io
      - MAIL_PORT=2525
      - MAIL_USERNAME=91ce3a2bcf0fe3
      - MAIL_PASSWORD=014d2184fd1aaf
      - MAIL_ENCRYPTION=
    command: ["php", "bin/hyperf.php", "start"]

  test-dashboard:
    build:
      context: ./docker/test-dashboard
      dockerfile: Dockerfile
    container_name: test-dashboard
    ports:
      - "${TEST_DASHBOARD_PORT:-3000}:3000"
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}-test
    environment:
      - API_HOST=hyperf-test
      - API_PORT=9501
      - DB_HOST=mysql-test
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-hyperf}_test
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - AUTO_POPULATE_COUNT=${AUTO_POPULATE_COUNT:-100}
    depends_on:
      mysql-test:
        condition: service_healthy
      hyperf-test:
        condition: service_started

  mysql-test:
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    container_name: ${CONTAINER_MYSQL:-mysql}-test
    volumes:
      - mysql-test-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${DB_TEST_PORT:-3308}:3306"
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}-test
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-root}
      - MYSQL_DATABASE=${DB_DATABASE:-hyperf}_test
      - MYSQL_USER=${DB_USERNAME:-hyperf}
      - MYSQL_PASSWORD=${DB_PASSWORD:-hyperf}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-root}"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5

  mailhog-test:
    build:
      context: ./docker/mailhog
      dockerfile: Dockerfile
    container_name: ${CONTAINER_MAILHOG:-mailhog}-test
    ports:
      - "${MAIL_TEST_PORT:-1026}:1025"
      - "${MAIL_TEST_WEB_PORT:-8026}:8025"
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}-test

networks:
  tecnofit-network-test:
    name: ${DOCKER_NETWORK:-tecnofit-network}-test
    driver: bridge

volumes:
  mysql-test-data:
    driver: local
