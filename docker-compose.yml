services:
  hyperf:
    build:
      context: .
      dockerfile: ./docker/hyperf/Dockerfile
    container_name: ${CONTAINER_HYPERF:-hyperf}
    volumes:
      - ./:/data/project
    ports:
      - "${HYPERF_PORT:-9501}:9501"
    working_dir: /data/project
    privileged: true
    user: root
    stdin_open: true
    tty: true
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - SCAN_CACHEABLE=${SCAN_CACHEABLE:-false}
      - DB_HOST=${DB_HOST:-mysql}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-hyperf}
      - DB_USERNAME=${DB_USERNAME:-hyperf}
      - DB_PASSWORD=${DB_PASSWORD:-hyperf}
      - MAIL_HOST=${MAIL_HOST:-mailhog}
      - MAIL_PORT=${MAIL_PORT:-1025}

  mysql:
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    container_name: ${CONTAINER_MYSQL:-mysql}
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${DB_EXTERNAL_PORT:-3307}:3306"
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-root}
      - MYSQL_DATABASE=${DB_DATABASE:-hyperf}
      - MYSQL_USER=${DB_USERNAME:-hyperf}
      - MYSQL_PASSWORD=${DB_PASSWORD:-hyperf}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-root}"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  mailhog:
    build:
      context: ./docker/mailhog
      dockerfile: Dockerfile
    container_name: ${CONTAINER_MAILHOG:-mailhog}
    ports:
      - "${MAIL_PORT:-1025}:1025"
      - "${MAIL_WEB_PORT:-8025}:8025"
    networks:
      - ${DOCKER_NETWORK:-tecnofit-network}

networks:
  tecnofit-network:
    name: ${DOCKER_NETWORK:-tecnofit-network}
    driver: bridge

volumes:
  mysql-data:
    driver: local
